# 変更履歴

このファイルには、プロジェクトの重要な変更や更新を記録します。

---

## 2025-12-24: プロジェクト初期構築

### Phase 1: 基盤構築完了

#### 追加ファイル
- `requirements.txt`: 依存ライブラリ定義
  - pandas, PuLP, PyYAML, tabulate, python-dateutil, pytest
- `utils/logger.py`: ログ設定モジュール
  - コンソール・ファイル出力対応
  - ログレベル設定機能
- `utils/date_utils.py`: 日付処理ユーティリティ
  - ローテーション期間計算
  - 週の範囲計算（月曜～日曜）
  - 期間内の月曜日・土日取得
  - 過去期間計算
- `src/data_loader.py`: CSVデータ読み込み・前処理
  - CSV読み込み機能
  - 重複行除去（179行削除）
  - 欠損値・変更マーカー除外（3行削除）
  - 直近N ヶ月のデータ抽出
  - メンバー履歴分析

#### データ処理結果
- **元データ**: 3,501レコード
- **クリーニング後**: 3,319レコード
- **直近2ヶ月**: 142レコード
- **アクティブメンバー**: 22名

---

### Phase 2: 設定管理完了

#### 追加ファイル
- `src/config_generator.py`: 設定ファイル自動生成モジュール
  - 過去2ヶ月のデータからメンバー分類
  - settings.yaml自動生成
  - ng_dates.yaml雛形生成
- `config/settings.yaml`: メンバー・制約設定（自動生成）
  - 日勤 index 1,2グループ: 16名
  - 日勤 index 3グループ: 5名
  - 夜勤 index 1グループ: 9名
  - 夜勤 index 2グループ: 5名（松田さん含む）
  - 松田さん隔週パターン設定（基準日: 2025-02-20）
- `config/ng_dates.yaml`: NG日設定雛形

#### メンバー分類ロジック
過去2ヶ月の実績データから以下の基準で自動分類:
- 日勤でindex 1または2に出現 → `day_shift.index_1_2_group`
- 日勤でindex 3に出現 → `day_shift.index_3_group`
- 夜勤でindex 1に出現 → `night_shift.index_1_group`
- 夜勤でindex 2に出現 → `night_shift.index_2_group`

#### 松田さん特別設定
- 夜勤 index 2に固定
- 隔週パターン（biweekly）
- 基準日を過去データから自動検出: 2025-02-20

---

### テスト実装完了

#### 追加ファイル
- `tests/test_date_utils.py`: 日付ユーティリティテスト（7テスト）
- `tests/test_data_loader.py`: データローダーテスト（6テスト）
- `tests/test_config_generator.py`: 設定生成テスト（5テスト）

#### テスト結果
- **合計**: 18テスト
- **成功**: 18テスト（100%）
- **失敗**: 0テスト

#### テスト検証項目
1. **日付処理**:
   - ローテーション期間計算（21日～2ヶ月後の20日）
   - 週の範囲計算（月曜～日曜）
   - 土日判定
2. **データ処理**:
   - CSV読み込み
   - 重複除去・欠損値除外
   - メンバー履歴分析
3. **設定生成**:
   - メンバー分類の正確性
   - 松田さんの設定
   - YAML保存・読み込み

---

### ドキュメント整備

#### 追加ファイル
- `.docs/CLAUDE.md`: プロジェクト説明書
  - プロジェクト概要
  - 技術スタック
  - 制約ルール詳細
  - データ分析結果
  - 使用方法
  - 実装状況
- `.docs/update.md`: このファイル
- `README.md`: プロジェクト概要（作成予定）

---

### データファイル移動
- `duty_roster_2021_2025.csv` をプロジェクトルートから `data/` ディレクトリに移動

---

### 技術的な決定事項

#### 設定ファイル管理方針
- **初回起動時**: 過去データから自動生成
- **2回目以降**: 既存ファイルを使用（手動編集可能）
- **理由**: 初期設定の手間を省きつつ、運用中の柔軟性を確保

#### メンバー分類基準
- **期間**: 直近2ヶ月
- **判定**: 過去の実績から自動分類
- **根拠**: ユーザー要件「直近2か月でindex 1,2に該当した人は3にはできない」

#### 松田さん隔週パターン
- **検出方法**: 過去データの最終出現日から計算
- **設定**: 夜勤 index 2固定、隔週パターン
- **根拠**: 過去データで376回出現、すべて夜勤 index 2

---

## 今後の予定

### Phase 3: 制約チェッカー実装（未着手）
- `src/member_manager.py`: メンバー情報管理
- `src/constraint_checker.py`: 制約条件チェック

### Phase 4: PuLP最適化エンジン実装（未着手）
- `src/optimizer.py`: 線形計画法による最適化
  - 変数定義
  - 目的関数構築
  - 制約条件の数式化

### Phase 5: スケジュール生成統括（未着手）
- `src/schedule_generator.py`: 全体統括
- `src/output_formatter.py`: 結果出力

### Phase 6: メインエントリーポイント（未着手）
- `main.py`: コマンドライン実行

---

## 技術的な課題と対処法（今後）

### 解が見つからない問題（Infeasible）
- **原因**: 制約が厳しすぎる、NG日が多い
- **対処**: 制約の優先順位付け、段階的緩和

### 計算時間の問題
- **原因**: 変数数・制約数が多い
- **対処**: ソルバーのタイムリミット設定、変数削減

### 公平性の問題
- **原因**: NG日が不均等、固定メンバー（松田さん）
- **対処**: 重み付き公平性、統計情報の詳細表示

---

## 参考リンク
- PuLP公式ドキュメント: https://coin-or.github.io/pulp/
- pandas公式ドキュメント: https://pandas.pydata.org/
- pytest公式ドキュメント: https://docs.pytest.org/
