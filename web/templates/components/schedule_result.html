<div class="animate-fade-in" style="margin-top: 30px;">
  <div class="card-header" style="border-bottom: none; padding-bottom: 0; margin-bottom: 20px;">
    <h3 style="margin: 0">作成結果 ({{ start_date }} ～ {{ end_date }})</h3>
    <form hx-post="/save_result" hx-target="#save-message">
      <input type="hidden" name="start_date" value="{{ start_date }}" />
      <button type="submit" class="btn btn-primary">CSV保存</button>
    </form>
  </div>
  <div id="save-message"></div>

  <!-- Statistics Summary -->
  {% if statistics and statistics.fairness %}
  <div class="stats-card">
    <h4 style="margin-top: 0">統計情報</h4>
    <div class="stats-grid">
      <div>
        <strong>公平性指標 (偏差比):</strong>
        {% set ratio = statistics.fairness.deviation_ratio %}
        <span class="{% if ratio <= 0.3 %}stat-value-good{% else %}stat-value-bad{% endif %}">
          {{ "%.2f"|format(ratio) }}
        </span>
      </div>
      <div>
        <strong>平均担当回数:</strong> {{
        "%.2f"|format(statistics.fairness.avg_count) }}回
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Day Schedule -->
  <h4>日勤スケジュール</h4>
  {% if schedule.day %}
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>日付</th>
          <th>当番1</th>
          <th>当番2</th>
          <th>当番3</th>
        </tr>
      </thead>
      <tbody>
        {% for date_key, indexes in schedule.day.items()|sort %}
        <tr>
          <td>{{ date_key }}</td>
          <td>{{ indexes.get(1, '-') }}</td>
          <td>{{ indexes.get(2, '-') }}</td>
          <td>{{ indexes.get(3, '-') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p>日勤スケジュールなし</p>
  {% endif %}

  <!-- Night Schedule -->
  <h4>夜勤スケジュール</h4>
  {% if schedule.night %}
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>週開始日</th>
          <th>夜勤1</th>
          <th>夜勤2</th>
        </tr>
      </thead>
      <tbody>
        {% for date_key, indexes in schedule.night.items()|sort %}
        <tr>
          <td>{{ date_key }}</td>
          <td>{{ indexes.get(1, '-') }}</td>
          <td>{{ indexes.get(2, '-') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p>夜勤スケジュールなし</p>
  {% endif %}

  <!-- Analysis Result -->
  {% if analysis %}
  <div style="margin-top: 40px; border-top: 2px solid #eee; padding-top: 20px">
    <h3>詳細分析レポート</h3>

    <!-- 1. Overlaps -->
    {% if analysis.overlaps %}
    <div class="result-alert alert-error">
      <h4 class="alert-title">⚠ 日勤・夜勤の重複警告</h4>
      <ul class="alert-list">
        {% for item in analysis.overlaps %}
        <li>
          <strong>{{ item.member }}</strong>: {{ item.details }}
          で重複しています
        </li>
        {% endfor %}
      </ul>
    </div>
    {% else %}
    <div class="result-alert alert-success">
      <span style="font-weight: bold; display: flex; align-items: center; gap: 6px;">
        ✔ 日勤・夜勤の期間内重複はありません
      </span>
    </div>
    {% endif %}

    <!-- 2. Close Intervals -->
    {% if analysis.close_intervals %}
    <div class="result-alert alert-warning">
      <h4 class="alert-title">⚠ 近接シフト (7日以内)</h4>
      <ul class="alert-list">
        {% for item in analysis.close_intervals %}
        <li>
          <strong>{{ item.member }}</strong>: {{ item.from }} から {{ item.to }}
          (間隔: {{ item.gap }}日)
        </li>
        {% endfor %}
      </ul>
    </div>
    {% else %}
    <div class="result-alert alert-success">
      <span style="font-weight: bold; display: flex; align-items: center; gap: 6px;">
        ✔ 7日以内の連続・近接シフトはありません
      </span>
    </div>
    {% endif %}

    <!-- 3. Member Counts -->
    <h4>メンバー別割当数 (直近2ヶ月 + 今回)</h4>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th rowspan="2">氏名</th>
            <th colspan="2">日勤回数</th>
            <th colspan="2">夜勤回数</th>
          </tr>
          <tr>
            <th>今回</th>
            <th>直近2ヶ月</th>
            <th>今回</th>
            <th>直近2ヶ月</th>
          </tr>
        </thead>
        <tbody>
          {% for item in analysis.member_counts %} {% if item.new_day > 0 or
          item.new_night > 0 or item.past_day > 0 or item.past_night > 0 %}
          <tr>
            <td>{{ item.name }}</td>
            <td><strong>{{ item.new_day }}</strong></td>
            <td style="color: var(--text-secondary)">{{ item.past_day }}</td>
            <td><strong>{{ item.new_night }}</strong></td>
            <td style="color: var(--text-secondary)">{{ item.past_night }}</td>
          </tr>
          {% endif %} {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
</div>