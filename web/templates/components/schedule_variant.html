<div class="variant-panel{% if is_active %} active{% endif %}" data-variant-panel="{{ variant.variant_index }}">
  <div class="card-header variant-header">
    <form hx-post="/save_result" hx-target="#save-message-{{ variant.variant_index }}">
      <input type="hidden" name="start_date" value="{{ start_date }}" />
      <input type="hidden" name="variant_index" value="{{ variant.variant_index }}" />
      <input type="hidden" name="variants" value="{{ variant_count }}" />
      <input type="hidden" name="variant_top_k" value="{{ variant_top_k }}" />
      <button type="submit" class="btn btn-primary">CSV保存</button>
    </form>
  </div>
  <div id="save-message-{{ variant.variant_index }}"></div>

  <!-- Statistics Summary -->
  {% if variant.statistics and variant.statistics.fairness %}
  <div class="stats-card">
    <h4 class="stats-title">統計情報</h4>
    <div class="stats-grid">
      <div>
        <strong>公平性指標 (偏差比):</strong>
        {% set ratio = variant.statistics.fairness.deviation_ratio %}
        <span class="{% if ratio <= 0.3 %}stat-value-good{% else %}stat-value-bad{% endif %}">
          {{ "%.2f"|format(ratio) }}
        </span>
      </div>
      <div>
        <strong>平均担当回数:</strong> {{
        "%.2f"|format(variant.statistics.fairness.avg_count) }}回
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Day Schedule -->
  <h4>日勤スケジュール</h4>
  {% if variant.schedule.day %}
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>日付</th>
          <th>当番1</th>
          <th>当番2</th>
          <th>当番3</th>
        </tr>
      </thead>
      <tbody>
        {% for date_key, indexes in variant.schedule.day.items()|sort %}
        <tr>
          <td>{{ date_key }}</td>
          <td>{{ indexes.get(1, '-') }}</td>
          <td>{{ indexes.get(2, '-') }}</td>
          <td>{{ indexes.get(3, '-') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p>日勤スケジュールなし</p>
  {% endif %}

  <!-- Night Schedule -->
  <h4>夜勤スケジュール</h4>
  {% if variant.schedule.night %}
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>週開始日</th>
          <th>夜勤1</th>
          <th>夜勤2</th>
        </tr>
      </thead>
      <tbody>
        {% for date_key, indexes in variant.schedule.night.items()|sort %}
        <tr>
          <td>{{ date_key }}</td>
          <td>{{ indexes.get(1, '-') }}</td>
          <td>{{ indexes.get(2, '-') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p>夜勤スケジュールなし</p>
  {% endif %}

  <!-- Analysis Result -->
  {% if variant.analysis %}
  <div class="analysis-section">
    <h3>詳細分析レポート</h3>

    <!-- 1. Overlaps -->
    {% if variant.analysis.overlaps %}
    <div class="result-alert alert-error">
      <h4 class="alert-title">? 日勤・夜勤の重複警告</h4>
      <ul class="alert-list">
        {% for item in variant.analysis.overlaps %}
        <li>
          <strong>{{ item.member }}</strong>: {{ item.details }}
          で重複しています
        </li>
        {% endfor %}
      </ul>
    </div>
    {% else %}
    <div class="result-alert alert-success">
      <span class="alert-inline">
        ? 日勤・夜勤の期間内重複はありません
      </span>
    </div>
    {% endif %}

    <!-- 2. Close Intervals -->
    {% if variant.analysis.close_intervals %}
    <div class="result-alert alert-warning">
      <h4 class="alert-title">? 近接シフト (7日以内)</h4>
      <ul class="alert-list">
        {% for item in variant.analysis.close_intervals %}
        <li>
          <strong>{{ item.member }}</strong>: {{ item.from }} から {{ item.to }}
          (間隔: {{ item.gap }}日)
        </li>
        {% endfor %}
      </ul>
    </div>
    {% else %}
    <div class="result-alert alert-success">
      <span class="alert-inline">
        ? 7日以内の連続・近接シフトはありません
      </span>
    </div>
    {% endif %}

    <!-- 3. Member Counts -->
    <h4>メンバー別割当数 (直近2ヶ月 + 今回)</h4>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th rowspan="2">氏名</th>
            <th colspan="2">日勤回数</th>
            <th colspan="2">夜勤回数</th>
          </tr>
          <tr>
            <th>今回</th>
            <th>直近2ヶ月</th>
            <th>今回</th>
            <th>直近2ヶ月</th>
          </tr>
        </thead>
        <tbody>
          {% for item in variant.analysis.member_counts %} {% if item.new_day > 0 or
          item.new_night > 0 or item.past_day > 0 or item.past_night > 0 %}
          <tr>
            <td>{{ item.name }}</td>
            <td><strong>{{ item.new_day }}</strong></td>
            <td class="text-secondary">{{ item.past_day }}</td>
            <td><strong>{{ item.new_night }}</strong></td>
            <td class="text-secondary">{{ item.past_night }}</td>
          </tr>
          {% endif %} {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
</div>
