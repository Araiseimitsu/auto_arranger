<form hx-post="/settings/update" hx-target="#settings-form-container">
  <div id="settings-form-container">
    {% if success_message %}
    <div class="result-alert alert-success animate-fade-in">
      {{ success_message }}
    </div>
    {% endif %}

    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px">
      ドラッグ＆ドロップでメンバーのグループを移動できます。<br />
      チェックボックスで有効/無効を切り替えます。
    </p>

    <!-- Basic Settings Section -->
    <h3 class="section-title title-orange">
      基本設定
    </h3>
    <div class="settings-block">
      <div>
        <label
          style="
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
          "
        >
          <input
            type="checkbox"
            name="matsuda_enabled"
            {%
            if
            settings.matsuda_schedule.enabled
            %}checked{%
            endif
            %}
            style="margin-right: 12px"
          />
          松田固定スケジュールを有効にする
        </label>
        <div style="margin-left: 32px">
          <label style="display: block; font-size: 14px; margin-bottom: 6px"
            >基準日</label
          >
          <input
            type="date"
            name="matsuda_reference_date"
            value="{{ settings.matsuda_schedule.reference_date }}"
            style="max-width: 200px;"
          />
          <p class="form-hint">
            隔週パターンの基準となる日付
          </p>
        </div>
      </div>

      <div
        style="
          margin-top: 24px;
          border-top: 1px solid rgba(0,0,0,0.05);
          padding-top: 24px;
        "
      >
        <h4 style="margin: 0 0 16px 0; font-size: 15px; color: var(--text-primary); font-weight: 600;">
          制約設定
        </h4>
        <div class="flex-row">
          <div class="col-responsive">
            <label>日勤間隔 (日)</label>
            <input
              type="number"
              name="min_days_day"
              value="{{ settings.constraints.interval.min_days_between_same_person_day }}"
              min="0"
            />
          </div>
          <div class="col-responsive">
            <label>夜勤間隔 (日)</label>
            <input
              type="number"
              name="min_days_night"
              value="{{ settings.constraints.interval.min_days_between_same_person_night }}"
              min="0"
            />
          </div>
          <div class="col-responsive">
            <label>当番3間隔 (日)</label>
            <input
              type="number"
              name="min_days_day_index3"
              value="{{ settings.constraints.interval.min_days_between_same_person_day_index3 | default(7) }}"
              min="0"
            />
            <p class="form-hint">
              代休あり
            </p>
          </div>
          <div class="col-responsive">
            <label>夜勤→日勤間隔 (日)</label>
            <input
              type="number"
              name="min_gap_night_day"
              value="{{ settings.constraints.night_to_day_gap.min_days }}"
              min="0"
            />
          </div>
        </div>
        <p class="form-hint" style="margin-top: 12px;">
          ※指定した日数以内の連続勤務を禁止します
        </p>
      </div>

        <p class="form-hint" style="margin-top: 12px;">
          <span class="icon">ℹ️</span> <strong>自動最適化:</strong> 日勤当番の直後の夜勤はなるべく避けるよう自動調整されます（絶対禁止ではありません）
        </p>
      </div>
    </div>

    <!-- Day Shift Section -->
    <h3 class="section-title title-blue">
      日勤メンバー
    </h3>
    <div class="flex-row">
      <!-- Day Group 1 & 2 -->
      <div class="member-group-container">
        <h4 class="member-group-title">
          休日1・2
        </h4>
        <div class="sortable-list day-list" data-input-name="day_index_1_2">
          {% for member in settings.members.day_shift.index_1_2_group %}
          <div class="member-card">
            <input
              type="hidden"
              name="day_index_1_2[]"
              value="{{ member.name }}"
              class="member-id"
            />
            <label
              style="
                display: flex;
                align-items: center;
                width: 100%;
                cursor: grab;
                margin: 0;
              "
            >
              <input
                type="checkbox"
                name="active_{{ member.name }}_day"
                {%
                if
                member.active
                %}checked{%
                endif
                %}
              />
              <span style="flex-grow: 1; font-weight: 500;">{{ member.name }}</span>
            </label>
            <button
              type="button"
              class="btn-remove"
              onclick="this.closest('.member-card').remove()"
              title="削除"
            >
              ×
            </button>
            <button
              type="button"
              class="btn-edit"
              onclick="openMemberModal('{{ member.name }}', '{{ member.min_days_day|default('') }}', '{{ member.min_days_night|default('') }}')"
              title="編集"
            >
              ✎
            </button>
          </div>
          {% endfor %}
        </div>
        <div class="add-member-container">
          <input
            type="text"
            placeholder="名前"
            class="add-member-input"
            onkeypress="if(event.key === 'Enter') { event.preventDefault(); addMember(this, 'day_index_1_2'); }"
          />
          <button
            type="button"
            class="btn-add"
            onclick="addMember(this.previousElementSibling, 'day_index_1_2')"
          >
            ＋
          </button>
        </div>
      </div>

      <!-- Day Group 3 -->
      <div class="member-group-container">
        <h4 class="member-group-title">
          休日3
        </h4>
        <div class="sortable-list day-list" data-input-name="day_index_3">
          {% for member in settings.members.day_shift.index_3_group %}
          <div class="member-card">
            <input
              type="hidden"
              name="day_index_3[]"
              value="{{ member.name }}"
              class="member-id"
            />
            <label
              style="
                display: flex;
                align-items: center;
                width: 100%;
                cursor: grab;
                margin: 0;
              "
            >
              <input
                type="checkbox"
                name="active_{{ member.name }}_day"
                {%
                if
                member.active
                %}checked{%
                endif
                %}
              />
              <span style="flex-grow: 1; font-weight: 500;">{{ member.name }}</span>
            </label>
            <button
              type="button"
              class="btn-remove"
              onclick="this.closest('.member-card').remove()"
              title="削除"
            >
              ×
            </button>
            <button
              type="button"
              class="btn-edit"
              onclick="openMemberModal('{{ member.name }}', '{{ member.min_days_day|default('') }}', '{{ member.min_days_night|default('') }}')"
              title="編集"
            >
              ✎
            </button>
          </div>
          {% endfor %}
        </div>
        <div class="add-member-container">
          <input
            type="text"
            placeholder="名前"
            class="add-member-input"
            onkeypress="if(event.key === 'Enter') { event.preventDefault(); addMember(this, 'day_index_3'); }"
          />
          <button
            type="button"
            class="btn-add"
            onclick="addMember(this.previousElementSibling, 'day_index_3')"
          >
            ＋
          </button>
        </div>
      </div>
    </div>

    <!-- Night Shift Section -->
    <h3 class="section-title title-green">
      夜勤メンバー
    </h3>
    <div class="flex-row">
      <!-- Night Group 1 -->
      <div class="member-group-container">
        <h4 class="member-group-title">
          夜勤1
        </h4>
        <div class="sortable-list night-list" data-input-name="night_index_1">
          {% for member in settings.members.night_shift.index_1_group %}
          <div class="member-card">
            <input
              type="hidden"
              name="night_index_1[]"
              value="{{ member.name }}"
              class="member-id"
            />
            <label
              style="
                display: flex;
                align-items: center;
                width: 100%;
                cursor: grab;
                margin: 0;
              "
            >
              <input
                type="checkbox"
                name="active_{{ member.name }}_night"
                {%
                if
                member.active
                %}checked{%
                endif
                %}
              />
              <span style="flex-grow: 1; font-weight: 500;">{{ member.name }}</span>
            </label>
            <button
              type="button"
              class="btn-remove"
              onclick="this.closest('.member-card').remove()"
              title="削除"
            >
              ×
            </button>
            <button
              type="button"
              class="btn-edit"
              onclick="openMemberModal('{{ member.name }}', '{{ member.min_days_day|default('') }}', '{{ member.min_days_night|default('') }}')"
              title="編集"
            >
              ✎
            </button>
          </div>
          {% endfor %}
        </div>
        <div class="add-member-container">
          <input
            type="text"
            placeholder="名前"
            class="add-member-input"
            onkeypress="if(event.key === 'Enter') { event.preventDefault(); addMember(this, 'night_index_1'); }"
          />
          <button
            type="button"
            class="btn-add"
            onclick="addMember(this.previousElementSibling, 'night_index_1')"
          >
            ＋
          </button>
        </div>
      </div>

      <!-- Night Group 2 -->
      <div class="member-group-container">
        <h4 class="member-group-title">
          夜勤2
        </h4>
        <div class="sortable-list night-list" data-input-name="night_index_2">
          {% for member in settings.members.night_shift.index_2_group %}
          <div class="member-card">
            <input
              type="hidden"
              name="night_index_2[]"
              value="{{ member.name }}"
              class="member-id"
            />
            <label
              style="
                display: flex;
                align-items: center;
                width: 100%;
                cursor: grab;
                margin: 0;
              "
            >
              <input
                type="checkbox"
                name="active_{{ member.name }}_night"
                {%
                if
                member.active
                %}checked{%
                endif
                %}
              />
              <span style="flex-grow: 1; font-weight: 500;">{{ member.name }}</span>
            </label>
            <button
              type="button"
              class="btn-remove"
              onclick="this.closest('.member-card').remove()"
              title="削除"
            >
              ×
            </button>
            <button
              type="button"
              class="btn-edit"
              onclick="openMemberModal('{{ member.name }}', '{{ member.min_days_day|default('') }}', '{{ member.min_days_night|default('') }}')"
              title="編集"
            >
              ✎
            </button>
          </div>
          {% endfor %}
        </div>
        <div class="add-member-container">
          <input
            type="text"
            placeholder="名前"
            class="add-member-input"
            onkeypress="if(event.key === 'Enter') { event.preventDefault(); addMember(this, 'night_index_2'); }"
          />
          <button
            type="button"
            class="btn-add"
            onclick="addMember(this.previousElementSibling, 'night_index_2')"
          >
            ＋
          </button>
        </div>
      </div>
    </div>

    <div style="margin-top: 30px; text-align: right">
      <button type="submit" class="btn btn-primary">設定を保存</button>
    </div>
  </div>

  <!-- Edit Member Modal -->
  <div id="member-modal" class="modal-overlay">
    <div class="modal animate-fade-in">
      <div class="modal-header">
        <h3 style="margin: 0; font-size: 20px;">
          メンバー設定: <span id="modal-member-name"></span>
        </h3>
        <button type="button" class="modal-close" onclick="closeMemberModal()">
          ×
        </button>
      </div>
      <div class="modal-body">
        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px">
          このメンバー固有の制約を設定します。空欄の場合は全体設定({{
          settings.constraints.interval.min_days_between_same_person_day }}日 /
          {{ settings.constraints.interval.min_days_between_same_person_night
          }}日)が適用されます。
        </p>

        <div class="form-group">
          <label>日勤 最小間隔 (日)</label>
          <input
            type="number"
            id="modal-min-days-day"
            placeholder="デフォルトを使用"
          />
        </div>

        <div class="form-group">
          <label>夜勤 最小間隔 (日)</label>
          <input
            type="number"
            id="modal-min-days-night"
            placeholder="デフォルトを使用"
          />
        </div>
      </div>
      <div style="margin-top: 30px; text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="closeMemberModal()"
        >
          キャンセル
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="saveMemberAttributes()"
        >
          保存
        </button>
      </div>
    </div>
  </div>
</form>