<form hx-post="/settings/update" hx-target="#settings-form-container">
  <div id="settings-form-container">
    {% if success_message %}
    <div
      style="
        background: #e8f5e9;
        color: #2e7d32;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 15px;
      "
    >
      {{ success_message }}
    </div>
    {% endif %}

    <p style="font-size: 14px; color: #666; margin-bottom: 20px">
      ドラッグ＆ドロップでメンバーのグループを移動できます。<br />
      チェックボックスで有効/無効を切り替えます。
    </p>

    <!-- Basic Settings Section -->
    <h3
      style="border-left: 4px solid #ff9500; padding-left: 10px; margin-top: 0"
    >
      基本設定
    </h3>
    <div
      style="
        background: #f5f5f7;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 30px;
      "
    >
      <div>
        <label
          style="
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
          "
        >
          <input
            type="checkbox"
            name="matsuda_enabled"
            {%
            if
            settings.matsuda_schedule.enabled
            %}checked{%
            endif
            %}
            style="margin-right: 8px"
          />
          松田固定スケジュールを有効にする
        </label>
        <div style="margin-left: 24px">
          <label style="display: block; font-size: 14px; margin-bottom: 5px"
            >基準日</label
          >
          <input
            type="date"
            name="matsuda_reference_date"
            value="{{ settings.matsuda_schedule.reference_date }}"
            style="padding: 8px; border-radius: 6px; border: 1px solid #ddd"
          />
          <p style="font-size: 12px; color: #666; margin-top: 4px">
            隔週パターンの基準となる日付
          </p>
        </div>
      </div>

      <div
        style="
          margin-top: 20px;
          border-top: 1px solid #e0e0e0;
          padding-top: 20px;
        "
      >
        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #555">
          制約設定
        </h4>
        <div style="display: flex; gap: 20px; flex-wrap: wrap">
          <div style="flex: 1; min-width: 150px">
            <label style="display: block; font-size: 13px; margin-bottom: 5px"
              >日勤間隔 (日)</label
            >
            <input
              type="number"
              name="min_days_day"
              value="{{ settings.constraints.interval.min_days_between_same_person_day }}"
              min="0"
              style="
                width: 100%;
                padding: 6px;
                border: 1px solid #ddd;
                border-radius: 4px;
              "
            />
          </div>
          <div style="flex: 1; min-width: 150px">
            <label style="display: block; font-size: 13px; margin-bottom: 5px"
              >夜勤間隔 (日)</label
            >
            <input
              type="number"
              name="min_days_night"
              value="{{ settings.constraints.interval.min_days_between_same_person_night }}"
              min="0"
              style="
                width: 100%;
                padding: 6px;
                border: 1px solid #ddd;
                border-radius: 4px;
              "
            />
          </div>
          <div style="flex: 1; min-width: 150px">
            <label style="display: block; font-size: 13px; margin-bottom: 5px"
              >夜勤→日勤間隔 (日)</label
            >
            <input
              type="number"
              name="min_gap_night_day"
              value="{{ settings.constraints.night_to_day_gap.min_days }}"
              min="0"
              style="
                width: 100%;
                padding: 6px;
                border: 1px solid #ddd;
                border-radius: 4px;
              "
            />
          </div>
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 8px">
          ※指定した日数以内の連続勤務を禁止します
        </p>
      </div>
    </div>

    <!-- Day Shift Section -->
    <h3
      style="
        border-left: 4px solid #0071e3;
        padding-left: 10px;
        margin-top: 20px;
      "
    >
      日勤メンバー
    </h3>
    <div style="display: flex; gap: 20px; flex-wrap: wrap">
      <!-- Day Group 1 & 2 -->
      <div class="member-group-container">
        <h4
          style="
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #555;
            text-transform: uppercase;
          "
        >
          休日1・2
        </h4>
        <div class="sortable-list day-list" data-input-name="day_index_1_2">
          {% for member in settings.members.day_shift.index_1_2_group %}
          <div class="member-card">
            <input
              type="hidden"
              name="day_index_1_2[]"
              value="{{ member.name }}"
              class="member-id"
            />
            <label
              style="
                display: flex;
                align-items: center;
                width: 100%;
                cursor: grab;
              "
            >
              <input
                type="checkbox"
                name="active_{{ member.name }}_day"
                {%
                if
                member.active
                %}checked{%
                endif
                %}
                style="width: auto; margin-right: 8px"
              />
              <span style="flex-grow: 1">{{ member.name }}</span>
            </label>
            <button
              type="button"
              class="btn-remove"
              onclick="this.closest('.member-card').remove()"
              title="削除"
            >
              ×
            </button>
            <button
              type="button"
              class="btn-edit"
              onclick="openMemberModal('{{ member.name }}', '{{ member.min_days_day|default('') }}', '{{ member.min_days_night|default('') }}')"
              title="編集"
            >
              ✎
            </button>
          </div>
          {% endfor %}
        </div>
        <div class="add-member-container">
          <input
            type="text"
            placeholder="名前"
            class="add-member-input"
            onkeypress="if(event.key === 'Enter') { event.preventDefault(); addMember(this, 'day_index_1_2'); }"
          />
          <button
            type="button"
            class="btn-add"
            onclick="addMember(this.previousElementSibling, 'day_index_1_2')"
          >
            ＋
          </button>
        </div>
      </div>

      <!-- Day Group 3 -->
      <div class="member-group-container">
        <h4
          style="
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #555;
            text-transform: uppercase;
          "
        >
          休日3
        </h4>
        <div class="sortable-list day-list" data-input-name="day_index_3">
          {% for member in settings.members.day_shift.index_3_group %}
          <div class="member-card">
            <input
              type="hidden"
              name="day_index_3[]"
              value="{{ member.name }}"
              class="member-id"
            />
            <label
              style="
                display: flex;
                align-items: center;
                width: 100%;
                cursor: grab;
              "
            >
              <input
                type="checkbox"
                name="active_{{ member.name }}_day"
                {%
                if
                member.active
                %}checked{%
                endif
                %}
                style="width: auto; margin-right: 8px"
              />
              <span style="flex-grow: 1">{{ member.name }}</span>
            </label>
            <button
              type="button"
              class="btn-remove"
              onclick="this.closest('.member-card').remove()"
              title="削除"
            >
              ×
            </button>
            <button
              type="button"
              class="btn-edit"
              onclick="openMemberModal('{{ member.name }}', '{{ member.min_days_day|default('') }}', '{{ member.min_days_night|default('') }}')"
              title="編集"
            >
              ✎
            </button>
          </div>
          {% endfor %}
        </div>
        <div class="add-member-container">
          <input
            type="text"
            placeholder="名前"
            class="add-member-input"
            onkeypress="if(event.key === 'Enter') { event.preventDefault(); addMember(this, 'day_index_3'); }"
          />
          <button
            type="button"
            class="btn-add"
            onclick="addMember(this.previousElementSibling, 'day_index_3')"
          >
            ＋
          </button>
        </div>
      </div>
    </div>

    <!-- Night Shift Section -->
    <h3
      style="
        border-left: 4px solid #34c759;
        padding-left: 10px;
        margin-top: 30px;
      "
    >
      夜勤メンバー
    </h3>
    <div style="display: flex; gap: 20px; flex-wrap: wrap">
      <!-- Night Group 1 -->
      <div class="member-group-container">
        <h4
          style="
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #555;
            text-transform: uppercase;
          "
        >
          夜勤1
        </h4>
        <div class="sortable-list night-list" data-input-name="night_index_1">
          {% for member in settings.members.night_shift.index_1_group %}
          <div class="member-card">
            <input
              type="hidden"
              name="night_index_1[]"
              value="{{ member.name }}"
              class="member-id"
            />
            <label
              style="
                display: flex;
                align-items: center;
                width: 100%;
                cursor: grab;
              "
            >
              <input
                type="checkbox"
                name="active_{{ member.name }}_night"
                {%
                if
                member.active
                %}checked{%
                endif
                %}
                style="width: auto; margin-right: 8px"
              />
              <span style="flex-grow: 1">{{ member.name }}</span>
            </label>
            <button
              type="button"
              class="btn-remove"
              onclick="this.closest('.member-card').remove()"
              title="削除"
            >
              ×
            </button>
            <button
              type="button"
              class="btn-edit"
              onclick="openMemberModal('{{ member.name }}', '{{ member.min_days_day|default('') }}', '{{ member.min_days_night|default('') }}')"
              title="編集"
            >
              ✎
            </button>
          </div>
          {% endfor %}
        </div>
        <div class="add-member-container">
          <input
            type="text"
            placeholder="名前"
            class="add-member-input"
            onkeypress="if(event.key === 'Enter') { event.preventDefault(); addMember(this, 'night_index_1'); }"
          />
          <button
            type="button"
            class="btn-add"
            onclick="addMember(this.previousElementSibling, 'night_index_1')"
          >
            ＋
          </button>
        </div>
      </div>

      <!-- Night Group 2 -->
      <div class="member-group-container">
        <h4
          style="
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #555;
            text-transform: uppercase;
          "
        >
          夜勤2
        </h4>
        <div class="sortable-list night-list" data-input-name="night_index_2">
          {% for member in settings.members.night_shift.index_2_group %}
          <div class="member-card">
            <input
              type="hidden"
              name="night_index_2[]"
              value="{{ member.name }}"
              class="member-id"
            />
            <label
              style="
                display: flex;
                align-items: center;
                width: 100%;
                cursor: grab;
              "
            >
              <input
                type="checkbox"
                name="active_{{ member.name }}_night"
                {%
                if
                member.active
                %}checked{%
                endif
                %}
                style="width: auto; margin-right: 8px"
              />
              <span style="flex-grow: 1">{{ member.name }}</span>
            </label>
            <button
              type="button"
              class="btn-remove"
              onclick="this.closest('.member-card').remove()"
              title="削除"
            >
              ×
            </button>
            <button
              type="button"
              class="btn-edit"
              onclick="openMemberModal('{{ member.name }}', '{{ member.min_days_day|default('') }}', '{{ member.min_days_night|default('') }}')"
              title="編集"
            >
              ✎
            </button>
          </div>
          {% endfor %}
        </div>
        <div class="add-member-container">
          <input
            type="text"
            placeholder="名前"
            class="add-member-input"
            onkeypress="if(event.key === 'Enter') { event.preventDefault(); addMember(this, 'night_index_2'); }"
          />
          <button
            type="button"
            class="btn-add"
            onclick="addMember(this.previousElementSibling, 'night_index_2')"
          >
            ＋
          </button>
        </div>
      </div>
    </div>

    <div style="margin-top: 30px; text-align: right">
      <button type="submit" class="btn btn-primary">設定を保存</button>
    </div>
  </div>

  <!-- Edit Member Modal -->
  <div id="member-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">
          メンバー設定: <span id="modal-member-name"></span>
        </h3>
        <button type="button" class="modal-close" onclick="closeMemberModal()">
          ×
        </button>
      </div>
      <div class="modal-body">
        <p style="font-size: 12px; color: #666; margin-bottom: 15px">
          このメンバー固有の制約を設定します。空欄の場合は全体設定({{
          settings.constraints.interval.min_days_between_same_person_day }}日 /
          {{ settings.constraints.interval.min_days_between_same_person_night
          }}日)が適用されます。
        </p>

        <label>日勤 最小間隔 (日)</label>
        <input
          type="number"
          id="modal-min-days-day"
          placeholder="デフォルトを使用"
        />

        <label>夜勤 最小間隔 (日)</label>
        <input
          type="number"
          id="modal-min-days-night"
          placeholder="デフォルトを使用"
        />
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="closeMemberModal()"
          style="margin-right: 10px"
        >
          キャンセル
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="saveMemberAttributes()"
        >
          保存
        </button>
      </div>
    </div>
  </div>

  <script>
    // Modal Logic is now in app.js
    let currentMemberName = "";

    function openMemberModal(name, minDaysDay, minDaysNight) {
      currentMemberName = name;
      document.getElementById("modal-member-name").textContent = name;
      document.getElementById("modal-min-days-day").value = minDaysDay || "";
      document.getElementById("modal-min-days-night").value =
        minDaysNight || "";

      const modal = document.getElementById("member-modal");
      modal.classList.add("active");
      modal.classList.add("show");
    }

    function closeMemberModal() {
      const modal = document.getElementById("member-modal");
      modal.classList.remove("active");
      modal.classList.remove("show");
      currentMemberName = "";
    }

    function saveMemberAttributes() {
      if (!currentMemberName) return;

      const data = {
        name: currentMemberName,
        min_days_day: document.getElementById("modal-min-days-day").value,
        min_days_night: document.getElementById("modal-min-days-night").value,
      };

      fetch("/settings/member/update", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      })
        .then((response) => response.json())
        .then((result) => {
          if (result.success) {
            closeMemberModal();
            // Reload the settings tab or show success
            // Simple way: trigger form submit or reload page?
            // Since this is HTMX context, let's just alert or ideally refresh part.
            // But the member card buttons have hardcoded values. We should reload the page.
            window.location.reload();
          } else {
            alert("エラー: " + result.error);
          }
        })
        .catch((error) => {
          alert("通信エラー: " + error);
        });
    }
  </script>
</form>
